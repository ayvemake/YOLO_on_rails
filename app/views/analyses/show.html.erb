<% content_for :header do %>
  <div class="flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900">Analyse #<%= @analysis.id %></h1>
      <% if @analysis.api_data&.dig("detections").present? %>
        <% detection_class = @analysis.api_data["detections"].first["class_name"] rescue nil %>
        <span class="px-3 py-1 text-sm font-semibold rounded-full 
          <%= detection_class == "PARTICLE" ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800" %>">
          <%= detection_class || "Inconnu" %>
        </span>
      <% end %>
    </div>
    <%= link_to analyses_path, class: "text-blue-600 hover:text-blue-900" do %>
      <i class="fas fa-arrow-left mr-1"></i> Retour aux analyses
    <% end %>
  </div>
<% end %>

<div class="analysis-results">
  <% if @analysis.status == 'completed' %>
    <h2>Résultats de l'analyse</h2>
    <p>Score global : <%= @analysis.score.round(2) %>%</p>
    
    <% if @analysis.api_data && @analysis.api_data['detections'].present? %>
      <h3>Détections (<%= @analysis.api_data['detections'].size %>)</h3>
      <div class="detections-grid">
        <% @analysis.api_data['detections'].each do |detection| %>
          <div class="detection-card <%= detection['is_defective'] ? 'defective' : 'ok' %>">
            <h4><%= detection['class_name'] %></h4>
            <p>Confiance : <%= (detection['confidence'] * 100).round(2) %>%</p>
            <p>Statut : <%= detection['is_defective'] ? 'Défectueux' : 'OK' %></p>
          </div>
        <% end %>
      </div>
    <% else %>
      <p>Aucune détection trouvée.</p>
    <% end %>
  <% elsif @analysis.status == 'failed' %>
    <div class="error-message">
      <h2>Erreur lors de l'analyse</h2>
      <p><%= @analysis.error_message %></p>
    </div>
  <% else %>
    <div class="loading">
      <h2>Analyse en cours...</h2>
      <p>Veuillez patienter pendant que nous analysons votre image.</p>
    </div>
  <% end %>
</div>

<!-- Images côte à côte -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
  <div class="border-t border-gray-200 p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Image originale -->
      <div>
        <h4 class="text-md font-semibold mb-2 text-center">Image originale</h4>
        <div class="border border-gray-200 rounded-lg p-2 h-full flex items-center justify-center">
          <% if @analysis.image.attached? %>
            <%= image_tag url_for(@analysis.image), class: "max-w-full h-auto rounded-lg shadow-md" %>
          <% else %>
            <p class="text-gray-500 italic">Aucune image disponible</p>
          <% end %>
        </div>
      </div>
      
      <!-- Image résultante -->
      <div>
        <h4 class="text-md font-semibold mb-2 text-center">Image analysée</h4>
        <div class="border border-gray-200 rounded-lg p-2 h-full flex items-center justify-center">
          <% if @analysis.result_image.attached? %>
            <%= image_tag url_for(@analysis.result_image), class: "w-full h-auto rounded-lg shadow-md" %>
          <% else %>
            <div class="text-center py-8">
              <% if @analysis.pending? || @analysis.processing? %>
                <div class="animate-pulse flex flex-col items-center">
                  <div class="rounded-full bg-gray-200 h-16 w-16 mb-4"></div>
                  <p class="text-gray-500">Traitement en cours...</p>
                </div>
              <% else %>
                <p class="text-gray-500 italic">Aucune image disponible</p>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Métriques simples -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
  <div class="px-4 py-5 sm:p-6">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-500">Confiance</h4>
        <p class="mt-1 text-2xl font-semibold">
          <%= number_to_percentage(@analysis.api_data&.dig("score").to_f * 100, precision: 1) %>
        </p>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-500">Temps de traitement</h4>
        <p class="mt-1 text-2xl font-semibold">
          <%= @analysis.api_data&.dig("metrics", "processing", "total") || "-" %>
        </p>
      </div>

      <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-500">Détections</h4>
        <p class="mt-1 text-2xl font-semibold">
          <%= @analysis.api_data&.dig("detections")&.size || 0 %>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Détections -->
<%= render partial: "detections" if @analysis.api_data&.dig("detections").present? %>

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', function() {
    // Connexion WebSocket uniquement si l'analyse est en cours
    <% if @analysis.pending? || @analysis.processing? %>
      const socket = new WebSocket('<%= @websocket_url %>');
      
      socket.onopen = function(e) {
        console.log('WebSocket connection established');
      };
      
      socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        // Vérifier si les données correspondent à notre analyse
        if (data.analysis_id === <%= @analysis.id %>) {
          // Mettre à jour l'interface utilisateur avec les résultats
          updateAnalysisUI(data);
          
          // Fermer la connexion WebSocket une fois les résultats reçus
          socket.close();
          
          // Rafraîchir la page pour afficher les résultats complets
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      };
    <% end %>
    
    // Ajouter des fonctionnalités d'interaction pour les images
    setupImageInteractions();
  });
  
  function setupImageInteractions() {
    // Ajouter des événements de survol pour les détections
    const resultImage = document.getElementById('result-image');
    if (resultImage) {
      // Ajouter une classe pour le curseur
      resultImage.classList.add('cursor-zoom-in');
      
      // Ajouter un événement de clic pour agrandir l'image
      resultImage.addEventListener('click', function() {
        toggleFullscreen('result-image');
      });
    }
  }
  
  function toggleFullscreen(imageId) {
    const image = document.getElementById(imageId);
    if (!image) return;
    
    // Créer un conteneur modal pour l'image en plein écran
    const modal = document.createElement('div');
    modal.classList.add('fixed', 'inset-0', 'z-50', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-90');
    
    // Créer une version agrandie de l'image
    const enlargedImg = document.createElement('img');
    enlargedImg.src = image.src;
    enlargedImg.classList.add('max-h-screen', 'max-w-screen', 'p-4');
    
    // Ajouter un bouton de fermeture
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
    closeBtn.classList.add('absolute', 'top-4', 'right-4', 'text-white', 'text-2xl', 'p-2');
    
    // Ajouter des informations sur les détections
    const infoPanel = document.createElement('div');
    infoPanel.classList.add('absolute', 'bottom-4', 'left-4', 'right-4', 'bg-black', 'bg-opacity-70', 'text-white', 'p-4', 'rounded', 'overflow-auto', 'max-h-60');
    
    // Ajouter le contenu des informations
    <% if @analysis.completed? && @analysis.analysis_results.any? %>
      let infoPanelContent = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      // Informations sur le modèle
      infoPanelContent += '<div><h3 class="text-lg font-bold mb-2">Modèle</h3>';
      infoPanelContent += '<ul class="text-sm">';
      infoPanelContent += '<li>Nom: <%= @analysis.api_data["model_name"] || "YOLOv8" %></li>';
      infoPanelContent += '<li>Précision: <%= number_to_percentage(@analysis.api_data["precision"] * 100, precision: 1) if @analysis.api_data["precision"] %></li>';
      infoPanelContent += '<li>Rappel: <%= number_to_percentage(@analysis.api_data["recall"] * 100, precision: 1) if @analysis.api_data["recall"] %></li>';
      infoPanelContent += '</ul></div>';
      
      // Détections
      infoPanelContent += '<div><h3 class="text-lg font-bold mb-2">Détections (<%= @analysis.analysis_results.count %>)</h3>';
      infoPanelContent += '<ul class="text-sm max-h-32 overflow-y-auto">';
      <% @analysis.analysis_results.each do |result| %>
        infoPanelContent += '<li class="mb-1 <%= result.status == "ok" ? "text-green-300" : "text-red-300" %>">';
        infoPanelContent += '<span class="font-medium"><%= result.status == "ok" ? "Conforme" : "Défaut détecté" %></span> - ';
        infoPanelContent += 'Type: <%= result.defect_type || "Inconnu" %> - ';
        infoPanelContent += 'Pos: (<%= result.position_x.round(1) %>, <%= result.position_y.round(1) %>) - ';
        infoPanelContent += 'Conf: <%= number_to_percentage(result.conformity_score, precision: 1) %>';
        infoPanelContent += '</li>';
      <% end %>
      infoPanelContent += '</ul></div>';
      
      infoPanelContent += '</div>';
      infoPanel.innerHTML = infoPanelContent;
    <% end %>
    
    // Ajouter les événements
    modal.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      document.body.removeChild(modal);
    });
    
    enlargedImg.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    
    // Assembler le modal
    modal.appendChild(enlargedImg);
    modal.appendChild(closeBtn);
    modal.appendChild(infoPanel);
    
    // Ajouter à la page
    document.body.appendChild(modal);
  }
<% end %> 